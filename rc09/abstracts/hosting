Жизнь без Apache: виртуальный хостинг на PHP-FastCGI
----
Аудитория: администраторы хостинга и многопользовательских систем

Повышенные требования к безопасности, быстродействию и устойчивости заставляют администраторов пересматривать традиционные подходы во всех областях ИТ. Вместе с тем, растут ожидания пользователей, заставляющие постоянно расширять функциональность. При построении современного хостинга популярное решение Apache+mod_php уже не всегда кажется оптимальным.

Основанный на успешной истории, доклад подробно разбирает построение многопользовательского корпоративного хостинга на Lighttpd, PHP-FastCGI и FreeBSD, от общей стратегии до детальных технических решений, от стадии проектирования до поддержки, документации и расширения.

Среди широкого круга рассмотренных вопросов представлены следующие. Безопасность и ограничения: традиционные средства Unix, ACL и флаги файловой системы, sudo, execwrap, setuid, квоты, лимиты, suhosin. Миграция с Apache: отказ от htaccess и организация функциональных аналогов. Клиентский доступ: ssh, sftp, scponly, ftps, pure-ftpd, net2ftp, phpmyadmin. База данных: mysql, корректировка кодировок, портируемые пути доступа. PHP: миграция с 4.x на 5.x, клиентский php.ini, борьба с нестабильностью. Логи: Lighttpd и rsyslogd, ротация. Автоматизация и упрощение: роли администраторов, операторов и пользователей, CLI- и CGI-скрипты, разработка решений со сложными требованиями к модели доступа. Обновление ПО. IPv6. Бекап и восстановление.

---------------------------

Начало. FreeBSD 4, Apache 1, PHP 4, 20Gb, 100+ сайтов. 2-3 года работы без обновлений софта и конфигов, никакой безопасности, несколько успешных атак. Битрикс на Solaris 10 под апаче и php4.

Надо. Максимально сохранить функционал. Довести безопасность до разумного уровня.

Как разграничить сайты? Патчить линукс и апаче или fastcgi. Выбран FastCGI. Из-за проблем с FastCGI под Apache, решили попробовать Lighttpd. В качестве ОС выбрана FreeBSD из-за портов и стабильности фичей типа квот и acl.

Lighttpd
 конфиг через шаблоны и скрипт, на базе членства пользователей в группах

rsyslogd
 lighttpd не умел раскладывать error-логи по папкам пользователей
 конфиг через скрипт, разбирает error-логи по папкам, не 100% точность, но близко. Неразобранные ошибки складываются в отдельный общий лог. Все ошибки вместе - в ещё один большой лог для удобства админов.

PHP
 выбран 5. Несмотря на то, что многие сайты писались под PHP4 и даже php3, решено выбрать php5 из-за объявленного deprecation php4 и для запаса по времени перед необходимым апгрейдом. Безопасность тоже играет роль.

Perl/CGI
 Execwrap, setuid

ACL
 Для защиты пользователей друг от друга. Группе пользователей запрещено заходитьв пользовательские папки. Без ACL это сделать не так просто, так как веб-сервер требует world-readable разрешений на всех статических файлах и FastCGI скриптах.

Quotas
 При создании пользователя ему выделяется дисковые квоты стандартных размеров в разделе с данными и /tmp.

Клиентский доступ
 ssh, scponly, net2ftp, pure-ftpd
